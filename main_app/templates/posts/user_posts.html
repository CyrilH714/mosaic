{% extends 'base.html' %}
{% load static %}
{% block head %}
<link rel="stylesheet" href="{% static 'css/posts/user_feed.css' %}" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
  #map {
    height: 350px;
    width: 100%;
    max-width: 600px;
    margin: 0 auto 2em auto;
    border-radius: 12px;
    border: 1px solid #ccc;
  }
</style>
{% endblock %}

{% block content %}
<h1>Welcome, {{ user.username }}!</h1>

<div id="map"></div>
<pre>{{ user_countries }}</pre>
{{ user_countries|json_script:"userCountryData" }}

<section class="post-list">
  {% for post in posts %}
    <a href="{% url 'post_detail' post.id %}" class="post-card-link">
      <article class="post-item" style="border: 1px solid #ddd; border-radius: 10px; padding: 1em; margin-bottom: 1em; background: #fafafa;">
        <h2>{{ post.title }}</h2>
        <p>{{ post.body|truncatewords:25 }}</p>
        <p><strong>Tags:</strong> {{ post.tags }}</p>
        <p><strong>Country:</strong> {{ post.country.name }}</p>
      </article>
    </a>
  {% empty %}
    <p>No posts available.</p>
  {% endfor %}
</section>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const map = L.map('map').setView([20, 0], 2);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  const userCountries = JSON.parse(document.getElementById("userCountryData").textContent);

  fetch("https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson")
    .then(res => res.json())
    .then(data => {
      L.geoJSON(data, {
        style: function (feature) {
        const isoCode = (feature.properties["ISO3166-1-Alpha-2"] || "").toUpperCase();
        console.log("Highlighting country code:", isoCode);  
        return {
            color: userCountries.includes(isoCode) ? "#2a9d8f" : "#ccc",
            fillOpacity: userCountries.includes(isoCode) ? 0.6 : 0.1,
            weight: 1
          };
        }
      }).addTo(map);
    });
});
</script>
{% endblock %}
