{% extends 'base.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/home.css' %}" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
  #map {
    height: 350px;
    width: 100%;
    max-width: 600px;
    margin: 0 auto 2em auto;
    border-radius: 12px;
    border: 1px solid #0d6efd;
    background-color: #f0f8ff;  
  }
</style>
{% endblock %}

{% block content %}
<section class="home-section">
  {% if user.is_authenticated %}
    <h1>Your Global Community Awaits</h1>

    <div id="map"></div>
    {{ user_countries|json_script:"userCountryData" }}

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const map = L.map("map").setView([20, 0], 2);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "Â© OpenStreetMap contributors",
        }).addTo(map);

        const userCountries = JSON.parse(
          document.getElementById("userCountryData").textContent
        );

        fetch("https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson")
          .then((res) => res.json())
          .then((data) => {
            L.geoJSON(data, {
              style: function (feature) {
                const isoCode = (feature.properties["ISO3166-1-Alpha-2"] || "").toUpperCase();
                return {
                  color: userCountries.includes(isoCode) ? "#2a9d8f" : "#ccc",
                  fillOpacity: userCountries.includes(isoCode) ? 0.6 : 0.1,
                  weight: 1,
                };
              },
            }).addTo(map);
          });
      });
    </script>

  {% else %}
    <section>
      <form action="{% url 'home' %}" method="post" class="login">
        <h1>Login</h1>
        {% csrf_token %}
        {{ form.as_p }}
        <input type="hidden" name="next" value="{{ next }}" />
        <button type="submit" class="btn submit">Login</button>
      </form>
    </section>
  {% endif %}
</section>
{% endblock %}
